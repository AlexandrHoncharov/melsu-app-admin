{% extends "base.html" %}

{% block content %}
<!-- Хлебные крошки -->
<nav class="flex mb-5" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="{{ url_for('dashboard.index') }}" class="text-gray-700 hover:text-primary-900">
                <i class="fas fa-home mr-2"></i>
                Дашборд
            </a>
        </li>
        <li>
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2 text-sm"></i>
                <a href="{{ url_for('teacher.teachers_list') }}" class="text-gray-700 hover:text-primary-900">
                    Преподаватели
                </a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2 text-sm"></i>
                <a href="{{ url_for('teacher.edit_teacher', teacher_id=teacher.id) }}" class="text-gray-700 hover:text-primary-900">
                    Редактирование преподавателя
                </a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2 text-sm"></i>
                <span class="text-gray-500">
                    Привязка к расписанию
                </span>
            </div>
        </li>
    </ol>
</nav>

<!-- Заголовок страницы -->
<div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-900">Привязка преподавателя к расписанию</h2>
    <p class="mt-1 text-sm text-gray-600">{{ teacher.full_name }}</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Форма привязки -->
    <div class="lg:col-span-2">
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="bg-gray-50 px-4 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Выбор преподавателя из расписания</h3>
            </div>
            <div class="p-4 md:p-6">
                <!-- Поиск преподавателя -->
                <div class="mb-6">
                    <label for="teacherSearch" class="block text-sm font-medium text-gray-700 mb-1">
                        Поиск преподавателя
                    </label>
                    <div class="relative mt-1 flex rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="teacherSearch" class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md" placeholder="Введите ФИО или код преподавателя">
                    </div>
                </div>

                <form method="POST" action="">
                    {{ form.hidden_tag() }}

                    <div class="space-y-6">
                        <div>
                            <label for="{{ form.schedule_teacher.id }}" class="block text-sm font-medium text-gray-700 mb-1">
                                {{ form.schedule_teacher.label.text }}
                            </label>
                            <div class="mt-1">
                                {% if form.schedule_teacher.choices|length > 0 %}
                                    {{ form.schedule_teacher(class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-700 focus:border-primary-700 sm:text-sm rounded-md", id="scheduleTeacherSelect") }}
                                    {% if form.schedule_teacher.errors %}
                                        <div class="mt-2 text-sm text-red-600">
                                            {% for error in form.schedule_teacher.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="py-4 text-center border border-gray-300 rounded-md bg-gray-50">
                                        <p class="text-gray-500">Нет доступных преподавателей в расписании</p>
                                        <a href="{{ url_for('schedule.upload_teachers') }}" class="mt-2 inline-flex items-center text-sm text-primary-900 hover:text-primary-700">
                                            <i class="fas fa-upload mr-1"></i> Загрузить данные преподавателей
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <a href="{{ url_for('teacher.edit_teacher', teacher_id=teacher.id) }}" class="inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-700 mr-3">
                                Отмена
                            </a>
                            {% if form.schedule_teacher.choices|length > 0 %}
                                {{ form.submit(class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-900 hover:bg-primary-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-700") }}
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Результаты поиска -->
        <div id="searchResults" class="mt-6 bg-white shadow rounded-lg overflow-hidden hidden">
            <div class="bg-gray-50 px-4 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">Результаты поиска</h3>
                <span id="resultsCount" class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">0 найдено</span>
            </div>
            <div class="p-4 md:p-6">
                <ul id="resultsList" class="divide-y divide-gray-200">
                    <!-- Результаты поиска будут здесь -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Информация и инструкции -->
    <div class="space-y-6">
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="bg-gray-50 px-4 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Информация</h3>
            </div>
            <div class="p-4 md:p-6 space-y-3">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                Привязка преподавателя к записи из расписания позволяет системе корректно идентифицировать преподавателей при формировании расписания.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="space-y-1">
                    <p class="text-sm text-gray-600">
                        <span class="font-medium">Преподаватель:</span> {{ teacher.full_name }}
                    </p>
                    <p class="text-sm text-gray-600">
                        <span class="font-medium">Должность:</span> {{ teacher.position or 'Не указана' }}
                    </p>
                    <p class="text-sm text-gray-600">
                        <span class="font-medium">Кафедра:</span> {{ teacher.department.name if teacher.department else 'Не указана' }}
                    </p>
                </div>

                <div class="mt-4">
                    <p class="text-sm text-gray-600">
                        {% if teacher.schedule_teacher %}
                            <span class="font-medium">Текущая привязка:</span> {{ teacher.schedule_teacher.code }} - {{ teacher.schedule_teacher.full_name }}
                        {% else %}
                            <span class="font-medium">Текущая привязка:</span> Не привязан к преподавателю из расписания
                        {% endif %}
                    </p>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="font-medium text-gray-900 text-sm mb-2">Как найти подходящего преподавателя:</h4>
                    <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                        <li>Воспользуйтесь полем поиска сверху для поиска преподавателей по ФИО или коду</li>
                        <li>Или выберите преподавателя из выпадающего списка, если вы точно знаете, кого выбрать</li>
                        <li>Нажмите "Сохранить" для завершения привязки</li>
                    </ol>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-sm text-gray-600">
                        Если нужного преподавателя нет в списке, его необходимо добавить, загрузив актуальный файл расписания.
                    </p>
                    <div class="mt-2">
                        <a href="{{ url_for('schedule.upload_teachers') }}" class="text-sm text-primary-900 hover:text-primary-700 inline-flex items-center">
                            <i class="fas fa-upload mr-1"></i> Загрузить данные преподавателей
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const teacherSearch = document.getElementById('teacherSearch');
        const scheduleTeacherSelect = document.getElementById('scheduleTeacherSelect');
        const searchResults = document.getElementById('searchResults');
        const resultsList = document.getElementById('resultsList');
        const resultsCount = document.getElementById('resultsCount');

        // Автоподсветка подходящего преподавателя
        function autoSelectBestMatch() {
            const teacherFullName = "{{ teacher.full_name }}".toLowerCase();
            let bestMatchIndex = -1;
            let bestMatchScore = 0;

            // Проходимся по всем опциям выпадающего списка
            Array.from(scheduleTeacherSelect.options).forEach((option, index) => {
                const optionText = option.text.toLowerCase();

                // Простое сравнение по количеству совпадающих подстрок
                let score = 0;

                // Извлекаем имя из опции (после кода и дефиса)
                const matches = optionText.match(/\d+ - (.*)/);
                const name = matches ? matches[1].trim() : optionText;

                // Разбиваем имена на слова
                const teacherWords = teacherFullName.split(' ');
                const optionWords = name.split(' ');

                // Считаем совпадения слов
                teacherWords.forEach(word => {
                    if (word.length < 3) return; // Пропускаем короткие слова

                    optionWords.forEach(optWord => {
                        if (optWord.length < 3) return;

                        // Если слово полностью совпадает
                        if (word === optWord) {
                            score += 10;
                        }
                        // Если слово начинается с той же подстроки
                        else if (word.startsWith(optWord) || optWord.startsWith(word)) {
                            score += 5;
                        }
                        // Если слово содержит подстроку
                        else if (word.includes(optWord) || optWord.includes(word)) {
                            score += 3;
                        }
                    });
                });

                // Обновляем лучшее совпадение
                if (score > bestMatchScore) {
                    bestMatchScore = score;
                    bestMatchIndex = index;
                }
            });

            // Выбираем лучшее совпадение, если оно достаточно хорошее
            if (bestMatchScore > 5 && bestMatchIndex >= 0) {
                scheduleTeacherSelect.selectedIndex = bestMatchIndex;
            }
        }

        // Функция поиска преподавателей
        function searchTeachers(query) {
            const options = Array.from(scheduleTeacherSelect.options);
            const results = [];

            // Поиск по опциям
            options.forEach(option => {
                const text = option.text.toLowerCase();
                const value = option.value;

                if (text.includes(query.toLowerCase())) {
                    results.push({
                        text: option.text,
                        value: value
                    });
                }
            });

            // Обновляем счетчик результатов
            resultsCount.textContent = `${results.length} найдено`;

            // Очищаем и заполняем список результатов
            resultsList.innerHTML = '';

            if (results.length === 0) {
                resultsList.innerHTML = '<li class="py-3 text-center text-gray-500">Ничего не найдено</li>';
                return;
            }

            results.forEach(result => {
                const listItem = document.createElement('li');
                listItem.className = 'py-3 flex justify-between items-center hover:bg-gray-50 cursor-pointer';
                listItem.innerHTML = `
                    <span class="text-sm text-gray-900">${result.text}</span>
                    <button type="button" class="text-sm text-primary-900 font-medium hover:text-primary-700">
                        Выбрать
                    </button>
                `;

                // Обработчик клика для выбора преподавателя
                listItem.addEventListener('click', () => {
                    scheduleTeacherSelect.value = result.value;
                    searchResults.classList.add('hidden');
                });

                resultsList.appendChild(listItem);
            });

            // Показываем результаты
            searchResults.classList.remove('hidden');
        }

        // Обработчик ввода в поле поиска
        teacherSearch?.addEventListener('input', function() {
            const query = this.value.trim();

            if (query.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }

            searchTeachers(query);
        });

        // Вызываем автоматический выбор при загрузке страницы
        if (scheduleTeacherSelect) {
            // Пробуем автоматически выбрать подходящего преподавателя
            autoSelectBestMatch();

            // Если в URL есть параметр schedule_teacher_id, выбираем его
            const urlParams = new URLSearchParams(window.location.search);
            const scheduleTeacherId = urlParams.get('schedule_teacher_id');

            if (scheduleTeacherId) {
                scheduleTeacherSelect.value = scheduleTeacherId;
            }
        }
    });
</script>
{% endblock %}
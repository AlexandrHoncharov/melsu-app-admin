{% extends 'base.html' %}

{% block content %}
<div class="bg-white shadow rounded-lg overflow-hidden">
    <!-- Заголовок страницы -->
    <div class="bg-gradient-to-r from-white to-gray-50 border-b px-6 py-5">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div class="flex items-center">
                <div class="bg-primary-700 text-white p-3 rounded-lg shadow-md mr-4 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Отправка уведомлений</h1>
                    <p class="text-sm text-gray-500 mt-1">Рассылка push-уведомлений пользователям мобильного приложения</p>
                </div>
            </div>
            <a href="{{ url_for('notifications_page') }}" class="btn-secondary flex items-center px-4 py-2 rounded-lg text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 transition-colors shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                История уведомлений
            </a>
        </div>
    </div>

    <!-- Основная форма -->
    <form id="notification-form" action="{{ url_for('send_notifications') }}" method="POST" class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Левая колонка: Содержимое уведомления -->
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Содержимое уведомления
                    </h2>

                    <div class="space-y-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Заголовок уведомления</label>
                            <input type="text" id="title" name="title"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors"
                                   placeholder="Важное сообщение" required>
                        </div>

                        <div>
                            <label for="message" class="block text-sm font-medium text-gray-700 mb-1">Текст уведомления</label>
                            <textarea id="message" name="message" rows="4"
                                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors"
                                     placeholder="Подробный текст уведомления" required></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="notification_type" class="block text-sm font-medium text-gray-700 mb-1">Тип уведомления</label>
                                <select id="notification_type" name="notification_type"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors">
                                    <option value="info">Информационное</option>
                                    <option value="important">Важное</option>
                                    <option value="schedule">Расписание</option>
                                    <option value="verification">Верификация</option>
                                    <option value="ticket">Тикет/обращение</option>
                                </select>
                            </div>

                            <div>
                                <label for="deep_link" class="block text-sm font-medium text-gray-700 mb-1">Глубокая ссылка (опционально)</label>
                                <input type="text" id="deep_link" name="deep_link"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors"
                                       placeholder="app://schedule">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Предпросмотр уведомления -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Предпросмотр уведомления
                    </h2>

                    <div class="bg-gray-50 rounded-xl border border-gray-200 p-5 max-w-sm mx-auto">
                        <div class="flex flex-col items-center">
                            <!-- Макет телефона -->
                            <div class="w-full max-w-[280px] bg-black rounded-3xl p-3 shadow-lg">
                                <div class="bg-white rounded-2xl overflow-hidden h-[420px]">
                                    <!-- Статус бар телефона -->
                                    <div class="bg-gray-100 flex justify-between items-center px-4 py-2 text-xs">
                                        <span>10:30</span>
                                        <div class="flex space-x-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10V6a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h8m3-12v6m-3-3h6" />
                                            </svg>
                                        </div>
                                    </div>

                                    <!-- Содержимое экрана -->
                                    <div class="p-4">
                                        <!-- Уведомление -->
                                        <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 mb-3">
                                            <div class="flex items-center mb-2">
                                                <div class="bg-primary-700 rounded-full w-10 h-10 flex items-center justify-center text-white mr-3">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                                    </svg>
                                                </div>
                                                <div>
                                                    <p class="font-bold text-gray-900" id="preview-title">Важное сообщение</p>
                                                    <p class="text-xs text-gray-500">Сейчас • my.melsu</p>
                                                </div>
                                            </div>
                                            <p class="text-gray-800" id="preview-message">Подробный текст уведомления будет здесь.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Правая колонка: Получатели уведомления -->
            <div class="space-y-6">
                <!-- Выбор получателей - новая карточка -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        Получатели уведомления
                    </h2>

                    <!-- Панель с вкладками для режимов выбора получателей -->
                    <div class="mb-6">
                        <div class="flex flex-wrap border-b border-gray-200">
                            <button type="button" class="tab-button active px-4 py-2 text-sm font-medium text-primary-700 border-b-2 border-primary-700" data-tab="single">
                                Один получатель
                            </button>
                            <button type="button" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" data-tab="group">
                                Группа студентов
                            </button>
                            <button type="button" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" data-tab="faculty">
                                Факультет
                            </button>
                            <button type="button" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" data-tab="department">
                                Кафедра
                            </button>
                            <button type="button" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" data-tab="course">
                                Курс
                            </button>
                            <button type="button" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" data-tab="all">
                                Все пользователи
                            </button>
                        </div>
                    </div>

                    <!-- Содержимое вкладок -->
                    <div class="tab-content" id="single-tab">
                        <div class="space-y-4">
                            <div>
                                <label for="direct_user_select" class="block text-sm font-medium text-gray-700 mb-1">Выберите пользователя из списка</label>
                                <select id="direct_user_select" name="selected_user_id"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors">
                                    <option value="">-- Выберите пользователя --</option>
                                    <optgroup label="Студенты">
                                        {% for user in all_users if user.role == 'student' %}
                                            <option value="{{ user.id }}">
                                                {{ user.full_name or user.username }}
                                                {% if user.group %}(Группа: {{ user.group }}){% endif %}
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                    <optgroup label="Преподаватели">
                                        {% for user in all_users if user.role == 'teacher' %}
                                            <option value="{{ user.id }}">
                                                {{ user.full_name or user.username }}
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                </select>
                            </div>

                            <div id="selected-user-info" class="hidden p-4 bg-primary-50 border border-primary-200 rounded-lg">
                                <div class="flex items-center">
                                    <div id="user-icon" class="bg-blue-100 text-blue-800 p-2 rounded-full mr-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <div id="user-name" class="font-semibold text-gray-800"></div>
                                        <div id="user-details" class="text-sm text-gray-600"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content hidden" id="group-tab">
                        <div class="space-y-4">
                            <div>
                                <label for="student_group" class="block text-sm font-medium text-gray-700 mb-1">Выберите группу</label>
                                <select id="student_group" name="student_group"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors">
                                    <option value="">Выберите группу</option>
                                    {% for group in groups %}
                                        <option value="{{ group }}">{{ group }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <div class="flex items-center mb-2">
                                    <input type="checkbox" id="include_subgroups" name="include_subgroups" class="h-4 w-4 text-primary-700 focus:ring-primary-700 border-gray-300 rounded">
                                    <label for="include_subgroups" class="ml-2 block text-sm text-gray-700">
                                        Учитывать подгруппы
                                    </label>
                                </div>

                                <div id="subgroups_container" class="hidden pl-6 border-l-2 border-primary-100">
                                    <div class="flex items-center mb-2">
                                        <input type="checkbox" id="subgroup_1" name="subgroups[]" value="1" class="h-4 w-4 text-primary-700 focus:ring-primary-700 border-gray-300 rounded">
                                        <label for="subgroup_1" class="ml-2 block text-sm text-gray-700">Подгруппа 1</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="subgroup_2" name="subgroups[]" value="2" class="h-4 w-4 text-primary-700 focus:ring-primary-700 border-gray-300 rounded">
                                        <label for="subgroup_2" class="ml-2 block text-sm text-gray-700">Подгруппа 2</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content hidden" id="faculty-tab">
                        <div class="space-y-4">
                            <div>
                                <label for="faculty" class="block text-sm font-medium text-gray-700 mb-1">Выберите факультет</label>
                                <select id="faculty" name="faculty"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors">
                                    <option value="">Выберите факультет</option>
                                    {% for faculty in faculties %}
                                        <option value="{{ faculty }}">{{ faculty }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Категория пользователей</label>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <input type="radio" id="faculty_all" name="faculty_recipient_type" value="all" checked class="h-4 w-4 text-primary-700 focus:ring-primary-700 border-gray-300">
                                        <label for="faculty_all" class="ml-2 block text-sm text-gray-700">Все (студенты и преподаватели)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" id="faculty_students" name="faculty_recipient_type" value="students" class="h-4 w-4 text-primary-700 focus:ring-primary-700 border-gray-300">
                                        <label for="faculty_students" class="ml-2 block text-sm text-gray-700">Только студенты</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" id="faculty_teachers" name="faculty_recipient_type" value="teachers" class="h-4 w-4 text-primary-700 focus:ring-primary-700 border-gray-300">
                                        <label for="faculty_teachers" class="ml-2 block text-sm text-gray-700">Только преподаватели</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content hidden" id="department-tab">
                        <div class="space-y-4">
                            <div>
                                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Выберите кафедру</label>
                                <select id="department" name="department"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors">
                                    <option value="">Выберите кафедру</option>
                                    {% for department in departments %}
                                        <option value="{{ department }}">{{ department }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div>
                                <label for="teacher_position" class="block text-sm font-medium text-gray-700 mb-1">Должность (необязательно)</label>
                                <select id="teacher_position" name="teacher_position"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors">
                                    <option value="">Все должности</option>
                                    {% for position in positions %}
                                        <option value="{{ position }}">{{ position }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content hidden" id="course-tab">
                        <div class="space-y-4">
                            <div>
                                <label for="course" class="block text-sm font-medium text-gray-700 mb-1">Выберите курс</label>
                                <select id="course" name="course"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors">
                                    <option value="">Выберите курс</option>
                                    <option value="1">1 курс</option>
                                    <option value="2">2 курс</option>
                                    <option value="3">3 курс</option>
                                    <option value="4">4 курс</option>
                                    <option value="5">5 курс</option>
                                    <option value="6">6 курс</option>
                                </select>
                            </div>

                            <div>
                                <label for="course_faculty" class="block text-sm font-medium text-gray-700 mb-1">Факультет (необязательно)</label>
                                <select id="course_faculty" name="course_faculty"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-primary-600 transition-colors">
                                    <option value="">Все факультеты</option>
                                    {% for faculty in faculties %}
                                        <option value="{{ faculty }}">{{ faculty }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content hidden" id="all-tab">
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <div class="flex items-start">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="text-sm text-blue-800">
                                        Уведомление будет отправлено всем пользователям приложения, включая студентов и преподавателей.
                                    </span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ограничить по статусу верификации</label>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <input type="radio" id="all_any" name="verification_status" value="" checked class="h-4 w-4 text-primary-700 focus:ring-primary-700 border-gray-300">
                                        <label for="all_any" class="ml-2 block text-sm text-gray-700">Все пользователи</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" id="all_verified" name="verification_status" value="verified" class="h-4 w-4 text-primary-700 focus:ring-primary-700 border-gray-300">
                                        <label for="all_verified" class="ml-2 block text-sm text-gray-700">Только верифицированные</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Индикатор активного режима выбора получателя для бэкенда -->
                    <input type="hidden" name="recipient_mode" id="recipient_mode" value="single">
                </div>

                <!-- Статистика получателей -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Статистика получателей
                    </h2>

                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-indigo-50 border border-indigo-100 rounded-xl px-4 py-3">
                                <div class="text-xs text-indigo-600 uppercase font-semibold mb-1">Пользователей</div>
                                <div class="text-2xl font-bold text-indigo-700" id="total_users">-</div>
                            </div>
                            <div class="bg-blue-50 border border-blue-100 rounded-xl px-4 py-3">
                                <div class="text-xs text-blue-600 uppercase font-semibold mb-1">Устройств</div>
                                <div class="text-2xl font-bold text-blue-700" id="total_devices">-</div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between mb-2">
                                <span class="text-sm text-gray-700">Примерное время отправки:</span>
                                <span class="text-sm font-semibold" id="estimated_time">-</span>
                            </div>

                            <button type="button" id="calculate-recipients-btn"
                                    class="w-full bg-primary-700 hover:bg-primary-800 text-white py-3 px-4 rounded-lg flex items-center justify-center transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                </svg>
                                Рассчитать получателей
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Кнопки действий -->
        <div class="flex justify-end mt-8 pt-4 border-t">
            <button type="button" id="send-notification-btn"
                    class="bg-primary-700 hover:bg-primary-800 text-white py-3 px-8 rounded-lg flex items-center shadow-lg transition-all transform hover:-translate-y-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                Отправить уведомление
            </button>
        </div>
    </form>
</div>

<!-- Диалог подтверждения отправки -->
<div id="confirm-dialog" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl transform transition-all">
        <div class="flex items-center mb-4">
            <div class="bg-yellow-100 p-3 rounded-full text-yellow-700 mr-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-lg font-bold text-gray-900">Подтверждение отправки</h3>
        </div>

        <p class="text-gray-700 mb-4">Вы собираетесь отправить уведомление <span id="confirm-count" class="font-semibold">N</span> пользователям. Продолжить?</p>

        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-6 flex items-start">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-sm text-yellow-700">
                После отправки уведомление получат все устройства выбранных пользователей. Отозвать уведомление будет невозможно.
            </p>
        </div>

        <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-send-btn"
                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                Отмена
            </button>
            <button type="button" id="confirm-send-btn"
                    class="px-4 py-2 bg-primary-700 hover:bg-primary-800 text-white rounded-lg transition-colors">
                Подтвердить отправку
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обновление превью уведомления
    document.getElementById('title').addEventListener('input', function() {
        document.getElementById('preview-title').textContent = this.value || 'Важное сообщение';
    });

    document.getElementById('message').addEventListener('input', function() {
        document.getElementById('preview-message').textContent = this.value || 'Подробный текст уведомления будет здесь.';
    });

    // Переключение вкладок получателей
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const recipientModeInput = document.getElementById('recipient_mode');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');

            // Активируем нужную вкладку
            tabButtons.forEach(btn => btn.classList.remove('active', 'text-primary-700', 'border-primary-700'));
            tabButtons.forEach(btn => btn.classList.add('text-gray-500', 'border-transparent'));
            this.classList.remove('text-gray-500', 'border-transparent');
            this.classList.add('active', 'text-primary-700', 'border-primary-700');

            // Показываем соответствующий контент
            tabContents.forEach(content => content.classList.add('hidden'));
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');

            // Обновляем скрытое поле с режимом выбора получателя
            recipientModeInput.value = tabName;

            // Сбрасываем предварительные расчеты
            resetRecipientStats();
        });
    });

    // Обработка выбора пользователя из выпадающего списка
    const userSelect = document.getElementById('direct_user_select');
    if (userSelect) {
        userSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const userId = this.value;
            const userName = selectedOption.textContent.trim();

            const userInfoDiv = document.getElementById('selected-user-info');
            const userNameEl = document.getElementById('user-name');
            const userDetailsEl = document.getElementById('user-details');
            const userIconEl = document.getElementById('user-icon');

            if (userId) {
                // Установка данных пользователя
                userNameEl.textContent = userName;

                // Определяем роль и группу по имени опции
                const isStudent = selectedOption.parentElement.label === 'Студенты';
                const groupMatch = userName.match(/\(Группа: (.*?)\)/);
                const group = groupMatch ? groupMatch[1] : '';

                userDetailsEl.textContent = isStudent
                    ? `Студент${group ? ` • Группа ${group}` : ''}`
                    : 'Преподаватель';

                userIconEl.className = isStudent
                    ? "bg-blue-100 text-blue-800 p-2 rounded-full mr-3"
                    : "bg-purple-100 text-purple-800 p-2 rounded-full mr-3";

                userInfoDiv.classList.remove('hidden');

                // Сбрасываем статистику получателей
                resetRecipientStats();
            } else {
                userInfoDiv.classList.add('hidden');
            }
        });
    }

    // Переключение подгрупп
    const includeSubgroups = document.getElementById('include_subgroups');
    if (includeSubgroups) {
        includeSubgroups.addEventListener('change', function() {
            const subgroupsContainer = document.getElementById('subgroups_container');
            if (this.checked) {
                subgroupsContainer.classList.remove('hidden');
            } else {
                subgroupsContainer.classList.add('hidden');
                // Снимаем выбор с чекбоксов подгрупп
                document.querySelectorAll('input[name="subgroups[]"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
        });
    }

    // Кнопка расчета получателей
    const calculateButton = document.getElementById('calculate-recipients-btn');
    if (calculateButton) {
        calculateButton.addEventListener('click', function() {
            calculateRecipients();
        });
    }

    // Кнопка отправки уведомления
    const sendButton = document.getElementById('send-notification-btn');
    if (sendButton) {
        sendButton.addEventListener('click', function() {
            showConfirmDialog();
        });
    }

    // Кнопки в диалоге подтверждения
    const cancelSendBtn = document.getElementById('cancel-send-btn');
    if (cancelSendBtn) {
        cancelSendBtn.addEventListener('click', function() {
            hideConfirmDialog();
        });
    }

    const confirmSendBtn = document.getElementById('confirm-send-btn');
    if (confirmSendBtn) {
        confirmSendBtn.addEventListener('click', function() {
            document.getElementById('notification-form').submit();
        });
    }
});

// Сброс статистики получателей
function resetRecipientStats() {
    document.getElementById('total_users').textContent = '-';
    document.getElementById('total_devices').textContent = '-';
    document.getElementById('estimated_time').textContent = '-';
}

// Функция расчета количества получателей
function calculateRecipients() {
    const recipientMode = document.getElementById('recipient_mode').value;

    // Показываем индикатор загрузки
    document.getElementById('total_users').innerHTML = `<div class="flex items-center"><div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-indigo-700 mr-2"></div> Загрузка...</div>`;
    document.getElementById('total_devices').innerHTML = `<div class="flex items-center"><div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-blue-700 mr-2"></div> Загрузка...</div>`;
    document.getElementById('estimated_time').textContent = 'Расчет...';

    // Имитация AJAX запроса к бэкенду для получения статистики
    setTimeout(() => {
        let usersCount = 0;
        let devicesCount = 0;

        // Логика расчета в зависимости от режима получателей
        switch(recipientMode) {
            case 'single':
                const selectedUserId = document.getElementById('direct_user_select').value;
                if (selectedUserId) {
                    usersCount = 1;
                    devicesCount = 2; // Предполагаем, что у пользователя может быть несколько устройств
                }
                break;

            case 'group':
                const selectedGroup = document.getElementById('student_group').value;
                if (selectedGroup) {
                    usersCount = 25; // Предполагаемое количество студентов в группе
                    devicesCount = 38; // Предполагаемое количество устройств
                }
                break;

            case 'faculty':
                const selectedFaculty = document.getElementById('faculty').value;
                if (selectedFaculty) {
                    const facultyRecipientType = document.querySelector('input[name="faculty_recipient_type"]:checked').value;

                    if (facultyRecipientType === 'all') {
                        usersCount = 350; // Студенты + преподаватели
                        devicesCount = 525;
                    } else if (facultyRecipientType === 'students') {
                        usersCount = 320; // Только студенты
                        devicesCount = 480;
                    } else if (facultyRecipientType === 'teachers') {
                        usersCount = 30; // Только преподаватели
                        devicesCount = 45;
                    }
                }
                break;

            case 'department':
                const selectedDepartment = document.getElementById('department').value;
                if (selectedDepartment) {
                    usersCount = 12; // Предполагаемое количество преподавателей на кафедре
                    devicesCount = 18;
                }
                break;

            case 'course':
                const selectedCourse = document.getElementById('course').value;
                if (selectedCourse) {
                    usersCount = 150; // Предполагаемое количество студентов на курсе
                    devicesCount = 225;
                }
                break;

            case 'all':
                const verificationStatus = document.querySelector('input[name="verification_status"]:checked').value;
                usersCount = verificationStatus === 'verified' ? 950 : 1250; // Все пользователи или только верифицированные
                devicesCount = verificationStatus === 'verified' ? 1425 : 1875;
                break;
        }

        // Обновляем UI
        document.getElementById('total_users').textContent = usersCount;
        document.getElementById('total_devices').textContent = devicesCount;

        // Расчет примерного времени отправки
        const timeInSeconds = Math.ceil(devicesCount / 10); // 1 секунда на 10 уведомлений
        let timeText = 'меньше минуты';

        if (timeInSeconds >= 60) {
            const minutes = Math.ceil(timeInSeconds / 60);
            timeText = `примерно ${minutes} ${minutes === 1 ? 'минута' : minutes < 5 ? 'минуты' : 'минут'}`;
        }

        document.getElementById('estimated_time').textContent = timeText;

    }, 1000);
}

// Показать диалог подтверждения отправки
function showConfirmDialog() {
    const usersCount = document.getElementById('total_users').textContent;

    // Проверки перед отправкой
    if (usersCount === '-' || usersCount === 'Загрузка...' || usersCount === 'Расчет...') {
        alert('Сначала рассчитайте количество получателей!');
        return;
    }

    const title = document.getElementById('title').value.trim();
    const message = document.getElementById('message').value.trim();

    if (!title || !message) {
        alert('Заполните заголовок и текст уведомления!');
        return;
    }

    if (usersCount === '0') {
        alert('Нет получателей для отправки уведомления!');
        return;
    }

    // Обновляем текст в диалоге
    document.getElementById('confirm-count').textContent = usersCount;

    // Показываем диалог
    document.getElementById('confirm-dialog').classList.remove('hidden');
}

// Скрыть диалог подтверждения
function hideConfirmDialog() {
    document.getElementById('confirm-dialog').classList.add('hidden');
}
</script>
{% endblock %}